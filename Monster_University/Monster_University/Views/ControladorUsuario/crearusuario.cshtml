@{
    ViewBag.Title = "Crear Usuario";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Contenedor principal con imagen de fondo y overlay -->
<div class="main-background">
    <div class="background-overlay"></div>
    <div class="dashboard-container">
        <!-- Tarjeta de Crear Usuario -->
        <div class="card" style="margin-bottom: 20px; background: rgba(255,255,255,0.95);">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px 10px 0 0;">
                <h3 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>Crear Nuevo Usuario
                </h3>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(ViewBag.Error))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>@ViewBag.Error
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @using (Html.BeginForm("CrearUsuario", "ControladorUsuario", FormMethod.Post, new { id = "formCrearUsuario" }))
                {
                    @Html.AntiForgeryToken()

                    <!-- SECCIÓN 1: Información Básica -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Información Básica
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-id-card me-1"></i>ID Usuario: *
                                        </label>
                                        <input type="text" name="UsuarioID" class="form-control"
                                               placeholder="Ej: USR001"
                                               required
                                               maxlength="5">
                                        <small class="text-muted">Máximo 5 caracteres</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-user me-1"></i>Nombre de Usuario: *
                                        </label>
                                        <input type="text" name="NombreUsuario" class="form-control"
                                               placeholder="Nombre para iniciar sesión"
                                               required>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-lock me-1"></i>Contraseña: *
                                        </label>
                                        <div class="input-group">
                                            <input type="password" name="Contrasena" id="Contrasena"
                                                   class="form-control"
                                                   placeholder="Mínimo 6 caracteres"
                                                   required
                                                   minlength="6">
                                            <button class="btn btn-outline-secondary" type="button" id="btnTogglePassword">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">Mínimo 6 caracteres</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-check-circle me-1"></i>Confirmar Contraseña: *
                                        </label>
                                        <input type="password" name="ConfirmarContrasena" id="ConfirmarContrasena"
                                               class="form-control"
                                               placeholder="Repita la contraseña"
                                               required>
                                        <div class="text-danger small" id="passwordError"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-circle me-1"></i>Estado: *
                                        </label>
                                        <select name="Estado" class="form-control" required>
                                            <option value="ACTIVO" selected>ACTIVO</option>
                                            <option value="INACTIVO">INACTIVO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                  
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success me-2" id="btnGuardar">
                            <i class="fas fa-save me-1"></i>Guardar Usuario
                        </button>
                        @Html.ActionLink("Cancelar", "Lista", "ControladorUsuario", null,
                            new { @class = "btn btn-secondary", @style = "text-decoration: none;" })
                    </div>
                }
            </div>
        </div>

        <!-- Información de Ayuda -->
        <div class="card" style="background: rgba(255,255,255,0.95);">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Información Importante
                </h4>
            </div>
            <div class="card-body">
                <div class="accordion" id="accordionInfo">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                <i class="fas fa-shield-alt me-2"></i>Seguridad de Contraseñas
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionInfo">
                            <div class="accordion-body">
                                <ul>
                                    <li>Las contraseñas se almacenan encriptadas en la base de datos</li>
                                    <li>Se recomienda usar combinación de letras, números y símbolos</li>
                                    <li>Evite usar información personal como contraseña</li>
                                    <li>La contraseña debe tener al menos 6 caracteres</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                <i class="fas fa-user-cog me-2"></i>Tipos de Usuario
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionInfo">
                            <div class="accordion-body">
                                <p><strong>ACTIVO:</strong> El usuario puede iniciar sesión y usar el sistema.</p>
                                <p><strong>INACTIVO:</strong> El usuario no podrá iniciar sesión hasta que se reactive.</p>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                <i class="fas fa-link me-2"></i>Relaciones del Usuario
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionInfo">
                            <div class="accordion-body">
                                <p><strong>ID Persona:</strong> Vincula el usuario a un registro en la tabla PEPER_PERSON (empleados, profesores).</p>
                                <p><strong>ID Carrera:</strong> Vincula el usuario a una carrera específica en MECARR_CARRERA.</p>
                                <p><strong>ID Estudiante:</strong> Vincula el usuario a un estudiante específico en MEEST_ESTUD.</p>
                                <p class="text-warning"><strong>Nota:</strong> Si especifica ID Estudiante, también debe especificar ID Carrera.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts específicos para esta vista -->
@section Scripts {
    <script>
        $(document).ready(function () {
            // Toggle password visibility
            $('#btnTogglePassword').click(function () {
                var passwordField = $('#Contrasena');
                var type = passwordField.attr('type');
                var icon = $(this).find('i');

                if (type === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });

            // Validación de contraseñas coincidentes
            $('#ConfirmarContrasena').on('keyup', function () {
                var password = $('#Contrasena').val();
                var confirmPassword = $(this).val();

                if (password !== confirmPassword) {
                    $('#passwordError').text('Las contraseñas no coinciden');
                    $(this).addClass('is-invalid');
                } else {
                    $('#passwordError').text('');
                    $(this).removeClass('is-invalid');
                }
            });

            // Validación de relación estudiante-carrera
            function validateStudentCareerRelation() {
                var estudianteId = $('input[name="MEEST_ID"]').val().trim();
                var carreraId = $('input[name="MECARR_ID"]').val().trim();

                if (estudianteId && !carreraId) {
                    $('input[name="MECARR_ID"]').addClass('is-invalid');
                    return false;
                } else {
                    $('input[name="MECARR_ID"]').removeClass('is-invalid');
                    return true;
                }
            }

            // Validar cuando se escribe en ID Estudiante
            $('input[name="MEEST_ID"]').on('keyup blur', function () {
                validateStudentCareerRelation();
            });

            // Validar cuando se escribe en ID Carrera
            $('input[name="MECARR_ID"]').on('keyup blur', function () {
                validateStudentCareerRelation();
            });

            // Validación del formulario
            $('#formCrearUsuario').submit(function (e) {
                var usuarioID = $('input[name="UsuarioID"]').val().trim();
                var nombreUsuario = $('input[name="NombreUsuario"]').val().trim();
                var contrasena = $('#Contrasena').val();
                var confirmarContrasena = $('#ConfirmarContrasena').val();
                var isValid = true;

                // Reset errores
                $('.form-control').removeClass('is-invalid');
                $('#passwordError').text('');

                // Validar ID Usuario
                if (usuarioID === '') {
                    $('input[name="UsuarioID"]').addClass('is-invalid');
                    isValid = false;
                }

                // Validar Nombre Usuario
                if (nombreUsuario === '') {
                    $('input[name="NombreUsuario"]').addClass('is-invalid');
                    isValid = false;
                }

                // Validar Contraseña
                if (contrasena.length < 6) {
                    $('#Contrasena').addClass('is-invalid');
                    isValid = false;
                }

                // Validar que las contraseñas coincidan
                if (contrasena !== confirmarContrasena) {
                    $('#ConfirmarContrasena').addClass('is-invalid');
                    $('#passwordError').text('Las contraseñas no coinciden');
                    isValid = false;
                }

                // Validar relación estudiante-carrera
                if (!validateStudentCareerRelation()) {
                    isValid = false;
                    Swal.fire({
                        icon: 'warning',
                        title: 'Relación incompleta',
                        text: 'Si especifica ID Estudiante, también debe especificar ID Carrera',
                        confirmButtonColor: '#667eea'
                    });
                }

                if (!isValid) {
                    e.preventDefault();
                    if (isValid) { // Si solo hay error de estudiante-carrera, ya mostramos el mensaje
                        Swal.fire({
                            icon: 'warning',
                            title: 'Datos incompletos',
                            text: 'Por favor complete todos los campos correctamente',
                            confirmButtonColor: '#667eea'
                        });
                    }
                } else {
                    // Mostrar indicador de carga
                    $('#btnGuardar').html('<i class="fas fa-spinner fa-spin me-1"></i>Guardando...');
                    $('#btnGuardar').prop('disabled', true);
                }
            });

            // Auto-hide alerts after 5 seconds
            setTimeout(function () {
                $('.alert').alert('close');
            }, 5000);

            // Enfocar primer campo
            $('input[name="UsuarioID"]').focus();

            // Validar relaciones al cargar la página
            validateStudentCareerRelation();
        });
    </script>

    <style>
        /* Contenedor principal con imagen de fondo */
        .main-background {
            background-image: url('/Content/Images/university-background.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        /* Overlay más oscuro para mejor legibilidad */
        .background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
        }

        /* Contenedor del dashboard */
        .dashboard-container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Estilos para las tarjetas */
        .card {
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
        }

        .card-header {
            border: none;
            font-weight: 600;
        }

        /* Botones */
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
        }

            .btn-success:hover {
                background: linear-gradient(135deg, #218838 0%, #1e9e8a 100%);
            }

        /* Formulario */
        .form-control {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

            .form-control:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            }

            .form-control.is-invalid {
                border-color: #dc3545;
            }

        /* Accordion */
        .accordion-button {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 600;
            color: #2c3e50;
        }

            .accordion-button:not(.collapsed) {
                color: #667eea;
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            }

        /* Campos opcionales */
        .bg-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .main-background {
                background-attachment: scroll;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .card-header h5 {
                font-size: 1rem;
            }
        }
    </style>
}